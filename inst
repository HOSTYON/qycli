#!/bin/bash

[[ $(whoami) != "root" ]] && echo "qycli has to be installed as root, try 'sudo -i' or 'su -' to become root, then try again." && exit

## Install qycli and stack with "wget -qO- qyc.li/inst | bash" or the dev version with "wget -qO- qyc.li/inst | bash -s v dev"
## or "wget -qO- qyc.li/inst | bash -s v dev k no phpv 8.0"

## Optimize the host if you are in a container with "wget -qO- qyc.li/kernel | bash"

inst_qycli() {
    [[ -f /usr/bin/qyc ]] && echo "qycli is already installed, stopping the process. Just type qyc to get the help message or go to qycli.org to learn." && exit
    [[ ! -d /var/opt/qycli ]] && mkdir /var/opt/qycli
    echo "branch_name=$branch_name" >/var/opt/qycli/cnf
    echo "sec_install=$sec_install" >>/var/opt/qycli/cnf
    echo "php_version=$php_version" >>/var/opt/qycli/cnf
    apt update && apt -y install git
    git -C /opt clone -b "$branch_name" https://github.com/HOSTYON/qycli
    git -C /opt clone https://github.com/HOSTYON/qycli-plugin
    cp /opt/qycli/bin/qyc /usr/bin/qyc
    chmod 755 /usr/bin/qyc
    #chmod 755 /opt/qycli/kernel
    #chmod 755 /opt/qycli/sec_firewall
    # shellcheck disable=1091
    source /opt/qycli/bin/stk
    # shellcheck disable=1091
    source /opt/qycli/bin/help
    # shellcheck disable=1091
    source /opt/qycli/bin/upd
    echo "qycli ($branch_name) was installed."
    if [[ "$kernel_tweaks" == "yes" ]]; then
        printf "Optimizing kernel configurations. You should restart after the full installation has finished.\n\n"
        # shellcheck disable=1091
        source /opt/qycli/kernel
    fi
    if [[ "$sec_install" == "yes" ]]; then
        printf "Securing the network. Only SSH and Cloudflare connections will be allowed.\n\n"
        # shellcheck disable=1091
        source /opt/qycli/sec_firewall
    fi
    printf "\nInstalling the qycli stack now.\n\n"
    upd_system_resources_qycli_cnf
    stk_install
}

branch_name=production
sec_install=yes
kernel_tweaks=yes
php_version=7.4

while [[ "$#" -gt 0 ]]; do
    case "$1" in
    v | version)
        if [[ "$2" == "beta" ]]; then
            branch_name=beta
        elif [[ "$2" == "dev" ]]; then
            branch_name=dev
        fi
        shift
        ;;
    s | sec | security)
        if [[ "$2" =~ ^(n|no)$ ]]; then
            sec_install=no
        fi
        shift
        ;;
    k | kernel | tweaks)
        if [[ "$2" =~ ^(n|no)$ ]]; then
            kernel_tweaks=no
        fi
        shift
        ;;
    phpv | php-version)
        if [[ "$2" =~ ^(7.4|8.0|8.1)$ ]]; then
            php_version=$2
        else
            echo 'Not supported PHP version, try again with "7.4", "8.0" or "8.1". Exiting.'
            exit
        fi
        shift
        ;;
    esac
    shift
done

inst_qycli
