#!/bin/bash

# stack install functions

# Variables
phpv=7.4 # Newest safe PHP Version

upd() {
    sudo apt update && sudo apt upgrade -y && sudo apt -y dist-upgrade && sudo apt -y autoremove && sudo snap refresh
}

cf_ips_nginx() {
    if [[ -f /etc/nginx/conf.d/cloudflare.conf ]]; then 
        sudo rm /etc/nginx/conf.d/cloudflare.conf; 
    fi
    for cfip in $(wget -qO- cloudflare.com/ips-v4; wget -qO- cloudflare.com/ips-v6); do
        sudo bash -c "echo 'set_real_ip_from "$cfip";' >> /etc/nginx/conf.d/cloudflare.conf"
    done
    sudo bash -c "echo 'real_ip_header CF-Connecting-IP;' >> /etc/nginx/conf.d/cloudflare.conf"
}

upd_qycli() {
    # Same as prod() in qycli
    sudo wget -qO /usr/bin/qyc qyc.li/bin/qyc && sudo chmod 755 /usr/bin/qyc
    sudo wget -qO /opt/qycli/stk qyc.li/bin/stk
    sudo wget -qO /opt/qycli/help qyc.li/bin/help
    sudo wget -qO /opt/qycli/fn qyc.li/bin/fn
    sudo wget -qO /opt/qycli/cnf/nginx/nginx.conf qyc.li/cnf/nginx/nginx.conf
    sudo wget -qO /opt/qycli/cnf/nginx/conf.d/mime-types.conf qyc.li/cnf/nginx/conf.d/mime-types.conf
    sudo wget -qO /opt/qycli/cnf/nginx/sites/dmn.tld.conf qyc.li/cnf/nginx/sites/dmn.tld.conf

    # Additional things
    sudo cp /opt/qycli/cnf/nginx/nginx.conf /etc/nginx/nginx.conf
    cf_ips_nginx
}

stk_nginx() {
    sudo apt -y install curl gnupg2 ca-certificates lsb-release
    echo "deb http://nginx.org/packages/mainline/ubuntu `lsb_release -cs` nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
    curl -fsSL https://nginx.org/keys/nginx_signing.key | sudo apt-key add -
    sudo apt update && sudo apt install nginx
    sudo cp /opt/qycli/cnf/nginx/nginx.conf /etc/nginx/nginx.conf
    sudo cp /opt/qycli/cnf/nginx/conf.d/mime-types.conf /etc/nginx/conf.d/mime-types.conf
    cf_ips_nginx
    nginx -t && systemctl restart nginx
    # Add self signed certificate
    sudo openssl req -new -x509 -nodes -days 7300 -newkey rsa:2048 -keyout /etc/ssl/openssl.key -out /etc/ssl/openssl.crt \
    -subj "/ST=qycli/L=qycli/O=qycli/OU=qycli/CN=qycli"
}

stk_mariadb() {
    sudo apt -y install apt-transport-https
    curl -LsS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash -s -- --skip-maxscale
    sudo apt -y install mariadb-server
    sudo rm /etc/apt/sources.list.d/*.old* # Remove old mariadb.list
    if ! grep -q skip-networking /etc/mysql/my.cnf; then
        sudo bash -c 'printf "\n[mysqld]\nskip-networking\n" >> /etc/mysql/my.cnf'
        sudo systemctl restart mysql
    fi
}

stk_php() {
    sudo apt -y install php${phpv}-bcmath php${phpv}-common php${phpv}-curl php${phpv}-fpm php${phpv}-gd php${phpv}-imagick \
    php${phpv}-mbstring php${phpv}-mysql php${ver}-redis php${phpv}-soap php${phpv}-xml php${phpv}-zip

}

stk_redis() {
    sudo apt install snapd -y
    sleep 2 && sudo snap set system refresh.timer=3:00-5:00 && sleep 1
    sudo snap install redis --channel=stable
    sudo usermod -g www-data redis
    sudo sed -i 's+*port 6379+# port 6379+g' /etc/redis/redis.conf
    sudo sed -i 's+tcp-backlog 511+# tcp-backlog 511+g' /etc/redis/redis.conf
    sudo sed -i 's+# unixsocket /var/run/redis/redis-server.sock+unixsocket /run/redis/redis-server.sock+g' /etc/redis/redis.conf
    sudo sed -i 's+# unixsocketperm 700+unixsocketperm 775+g' /etc/redis/redis.conf
    sudo sed -i 's+appendfsync everysec+# appendfsync everysec+g' /etc/redis/redis.conf
    sudo sed -i 's+# appendfsync no+appendfsync no+g' /etc/redis/redis.conf
    sudo sed -i 's+no-appendfsync-on-rewrite no+no-appendfsync-on-rewrite yes+g' /etc/redis/redis.conf
    local redismem=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/100000)*20)) # 20% of all memory
    sudo sed -i "s+# maxmemory <bytes>+# maxmemory ${redismem}mb+g" /etc/redis/redis.conf
    sudo sed -i 's+# maxmemory-policy noeviction+maxmemory-policy allkeys-lfu+g' /etc/redis/redis.conf
    sudo sed -i 's+save 900 1+save 1800 1+g' /etc/redis/redis.conf
    sudo sed -i 's+save 300 10+save 600 10+g' /etc/redis/redis.conf
    sudo systemctl restart redis-server
}

stk_wpcli() {
    sudo curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    sudo chmod +x wp-cli.phar
    sudo mv wp-cli.phar /usr/local/bin/wp
}

stk_wp() {
    upd && stk_nginx && stk_mariadb && stk_php && stk_redis && stk_wpcli
}