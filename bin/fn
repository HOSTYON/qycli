#!/bin/bash

# function library for qyc

mk_wp() {
    if [[ "$1" == *"."* ]]; then
        domain="$1"
        [[ "$1" == www.* ]] && domain=$(echo "$1" | cut -c 5-)
        [[ -d /var/www/$domain ]] && printf "\nWP site already exists.\n" && exit
        shift
    else
        printf "\nInvalid domain: $1"
        print_help_wp
        exit
    fi

    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            u|user|admin)
                wpadmin="$2"
                shift
                ;;
            t|title)
                wptitle="$2"
                shift
                ;;
            p|password)
                wppw="$2" # Passwords with # have to be in quotes
                shift
                ;;
            e|email)
                wpemail="$2"
                shift
                ;;
            *)
                printf "\nInvalid option: $1"
                print_help_wp
                ;;
        esac
        shift
    done

    echo "Creating database..."
    local dbpassword=$(sudo openssl rand -base64 12)
    #local qycpw=$(grep "MariaDB qyc" /etc/qycli/qycli.cnf | sed 's/^.*: //') # Reading the qycli.cnf file
    local dbnaming="qyc_$(echo ${domain} | sed "s+[^0-9A-Za-z]+_+g")"
	sudo runuser -u mysql -- mysql --user=mysql <<EOF
CREATE USER ${dbnaming}@localhost IDENTIFIED BY '${dbpassword}';
CREATE DATABASE ${dbnaming};
GRANT ALL PRIVILEGES ON ${dbnaming}.* TO ${dbnaming}@localhost;
FLUSH PRIVILEGES;
EOF

    echo "Installing WordPress..."
    sudo mkdir -p /var/www/$domain/htdocs
    sudo wget -qrO /var/www/$domain/htdocs/latest.tar.gz https://wordpress.org/latest.tar.gz
    sudo tar -xf /var/www/$domain/htdocs/latest.tar.gz -C /var/www/$domain/
	sudo mv /var/www/$domain/wordpress/* /var/www/$domain/htdocs/
	sudo rm -rf /var/www/$domain/wordpress
	sudo rm /var/www/$domain/htdocs/latest.tar.gz

    sudo cp /var/www/$domain/htdocs/wp-config-sample.php /var/www/$domain/wp-config.php
    sudo chown www-data:www-data -R /var/www/$domain/*
    sudo sed -i "s+'DB_NAME', 'database_name_here'+'DB_NAME', '${dbnaming}'+g" /var/www/$domain/wp-config.php
    sudo sed -i "s+'DB_USER', 'username_here'+'DB_USER', '${dbnaming}'+g" /var/www/$domain/wp-config.php
    sudo sed -i "s#'DB_PASSWORD', 'password_here'#'DB_PASSWORD', '${dbpassword}'#g" /var/www/$domain/wp-config.php
    sudo sed -i "s+'DB_HOST', 'localhost'+'DB_HOST', ':/run/mysqld/mysqld.sock'+g" /var/www/$domain/wp-config.php
    wp --path=/var/www/$domain/htdocs config shuffle-salts
    sudo sed -i "s+$table_prefix = 'wp_';+$table_prefix = 'qyc_';+" /var/www/$domain/wp-config.php

    [[ "$wptitle" == "" ]] && wptitle=$domain
    [[ "$wpadmin" == "" ]] && wpadmin=qycli
    if [[ "$wppw" == "" ]]; then
        wppw=$(sudo openssl rand -base64 18)
    elif [[ ! $(echo "$wppw" | pwscore) ]]; then
        echo "Strong password is being generated."
        wppw=$(sudo openssl rand -base64 18)
    fi
    [[ "$wpemail" == "" ]] && wpemail=info@$domain
    wp --path=/var/www/$domain/htdocs core install --url=https://$domain --title=$wptitle --admin_user=$wpadmin --admin_password=$wppw --admin_email=$wpemail
    #wp --path=/var/www/$domain/htdocs search-replace 'http://$domain' 'https://$domain' --dry-run

    printf "Activating site...\n"
    sudo cp /etc/nginx/wp.tld /etc/nginx/sites-available/$domain
    sudo sed -i "s/dmn.tld/$domain/g"  /etc/nginx/sites-available/$domain
    sudo ln -s /etc/nginx/sites-available/$domain /etc/nginx/sites-enabled/
    sudo nginx -s reload

    wp --path=/var/www/$domain/htdocs rewrite structure /%postname%/
    wp --path=/var/www/$domain/htdocs plugin uninstall hello akismet
    wp --path=/var/www/$domain/htdocs theme update --all
    wp --path=/var/www/$domain/htdocs plugin install --activate cloudflare
    wp --path=/var/www/$domain/htdocs config set CLOUDFLARE_HTTP2_SERVER_PUSH_ACTIVE true

    printf "\n$domain is ready.\n\n"
    printf "    User:     $wpadmin\n"
    printf "    Email:    $wpemail\n"
    printf "    Password: $wppw\n\n"
    printf "Add this IPv6 address as an AAAA record in Cloudflare with proxy enabled (orange cloud):\n"
    printf "    $(ip -6 a | grep inet6 | awk -F '[ \t]+|/' '{print $3}' | grep -v ^::1 | grep -v ^fe80)\n\n"
    printf "Then login here: https://$domain/wp-login.php\n\n"
}

del_site() {
    sudo rm /etc/nginx/sites-enabled/$domain
    sudo rm /etc/nginx/sites-available/$domain
    sudo rm -r /var/www/$domain/*
    sudo rmdir /var/www/$domain
    printf "Files deleted.\n"
    local dbnaming="qyc_$(echo ${domain} | sed "s+[^0-9A-Za-z]+_+g")"
    sudo mysql <<EOF
DROP USER ${dbnaming}@localhost;    
DROP DATABASE ${dbnaming};
EOF
    sudo systemctl reload php${phpv}-fpm
    printf "Database deleted.\n"
    printf "$domain deleted.\n"
}

del_parser() {
    if [[ "$1" == *"."* ]]; then
        domain="$1"
        [[ "$1" == www.* ]] && domain=$(echo "$1" | cut -c 5-)
        [[ ! -d /var/www/$domain ]] && printf "\nSite does not exist." && print_help_del && exit
        shift
    else
        printf "\nInvalid domain: $1"
        print_help_del
        exit
    fi

    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            -y|yes) 
                proceed=yes 
                shift
                ;;
        esac
    done

    if [[ "$proceed" == "yes" ]]; then
        del_site
    else
        echo -n "Do you want to delete the site $domain? [y/Y/yes]: "
        read consent
        if [[ "$consent" == "yes" || "$consent" == "y" || "$consent" == "Y" ]]; then
            del_site
        else
            printf "Not deleting site.\n"
            exit
        fi
    fi
}

set_cache_object() {
    if [[ "$1" == "on" ]]; then
        if [[ -f /var/www/$domain/htdocs/object-cache.php ]]; then
            echo "Object cache is already enabled."
        else
            wp --path=/var/www/$domain/htdocs plugin install --activate wp-redis
            wp --path=/var/www/$domain/htdocs config set WP_CACHE_KEY_SALT "qyc_$domain"
            if [[ ! $(grep "redis_server" /var/www/$domain/wp-config.php) ]]; then
                sudo sed -i "/That's all, stop editing/i\$redis_server = array( 'host' => '/run/redis/redis-server.sock','port' => null,'database' => 0, );" /var/www/$domain/wp-config.php
            fi
                sudo ln -s /var/www/$domain/htdocs/wp-content/plugins/wp-redis/object-cache.php /var/www/$domain/htdocs/object-cache.php
                wp --path=/var/www/$domain/htdocs transient delete-all
        fi
    elif [[ "$1" == "off" ]]; then
        if [[ ! -f /var/www/$domain/htdocs/object-cache.php ]]; then
            echo "Object cache is already disabled."
        else
            wp --path=/var/www/$domain/htdocs plugin deactivate wp-redis
            sudo rm /var/www/$domain/htdocs/object-cache.php
            wp --path=/var/www/$domain/htdocs transient delete-all
        fi
    else
        print_help_set
    fi
}

set_cache_fcgi() {
    if [[ "$1" == "on" ]]; then
        sudo sed -i "s+    include common/php${phpv}.conf;+    #include common/php${phpv}.conf;+" /etc/nginx/sites-available/$domain
        sudo sed -i "s+#include common/wpfcgi${phpv}.conf;+include common/wpfcgi${phpv}.conf;+" /etc/nginx/sites-available/$domain
        wp --path=/var/www/$domain/htdocs plugin install --activate nginx-helper
        sudo nginx -s reload
    elif [[ "$1" == "off" ]]; then
        sudo sed -i "s+#include common/php${phpv}.conf;+include common/php${phpv}.conf;+" /etc/nginx/sites-available/$domain
        sudo sed -i "s+    include common/wpfcgi${phpv}.conf;+    #include common/wpfcgi${phpv}.conf;+" /etc/nginx/sites-available/$domain
        wp --path=/var/www/$domain/htdocs plugin deactivate nginx-helper
        sudo nginx -s reload
    else
        print_help_set
    fi
}

set_cache_parser() {
    if [[ "$1" == *"."* ]]; then
        domain="$1"
        [[ "$1" == www.* ]] && domain=$(echo "$1" | cut -c 5-)
        [[ ! -d /var/www/$domain ]] && printf "\nSite does not exist." && print_help_del && exit
        shift
    else
        printf "\nInvalid domain: $1\n"
        print_help_set
        exit
    fi

    if [[ "$1" == "object" || "$1" == "o" ]]; then
        shift
        set_cache_object "$@"
    elif [[ "$1" == "fcgi" || "$1" == "f" ]]; then
        shift
        set_cache_fcgi "$@"
    elif [[ "$1" == "all" || "$1" == "both" ]]; then
        shift
        set_cache_object "$@"
        set_cache_fcgi "$@"
    elif [[ "$1" == "on" || "$1" == "off" ]]; then
        set_cache_object "$@"
        set_cache_fcgi "$@"
    else
        printf "\nInvalid option: $1\n"
        print_help_set
        exit
    fi 
}

mk() {
    if [[ "$1" == "wp" ]]; then
        shift
        mk_wp "$@"
    else
        print_help_mk
    fi
}

ls() {
    printf "\n"
    printf "All sites available:\n\n"
    for name in /etc/nginx/sites-available/*
    do
        printf "    $(echo ${name} | sed "s+/etc/nginx/sites-available/++")\n"
    done
    printf "\n"
}

dev_upd() {
    wget -qO- qyc.li/inst | sudo bash -s dev
}

qyc_set() {
    if [[ "$1" == "cache" ]]; then
        shift
        set_cache_parser "$@"
    else
        print_help_set
    fi
}

del() {
    if [[ "$1" == "" ]]; then
        print_help_del
    else
        del_parser "$@"
    fi
}

