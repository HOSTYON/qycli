#!/bin/bash

get_public_ips() {
    ipv4_dev=$(ip r | awk '/default via/ {print $5}' | head -n1)
    ipv4=$(ip -4 a show dev "$ipv4_dev" scope global | grep inet | awk -F '[ \t]+|/' '{print $3}' | grep -Ev "10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" |
        grep -Ev "172\.([1][6-9]|[2][0-9]|3[0-1]{1,3})\.[0-9]{1,3}\.[0-9]{1,3}" | grep -Ev "192\.168\.[0-9]{1,3}\.[0-9]{1,3}")
    ipv6_dev=$(ip -6 r | awk '/default via/ {print $5}' | head -n1)
    ipv6=$(ip -6 a show dev "$ipv6_dev" scope global | grep inet6 | awk -F '[ \t]+|/' '{print $3}' | grep -v ^::1 | grep -v ^fe80 | grep -v ^fd00)
}

#  qycli update functions
upd_qycli() {
    git -C /var/qyc/qycli reset --hard HEAD
    git -C /var/qyc/qycli pull
    git -C /var/qyc/qycli-plugin reset --hard HEAD
    git -C /var/qyc/qycli-plugin pull
    cp /var/qyc/qycli/bin/qyc /usr/bin/qyc
    chmod 755 /usr/bin/qyc
    chmod 755 /var/qyc/qycli/kernel
    chmod 755 /var/qyc/qycli/sec_firewall
}

upd_apt() {
    if dir /etc/apt/sources.list.d/ | grep -q old; then
        rm /etc/apt/sources.list.d/*.old* # Remove old mariadb.list
    fi
    apt update && apt upgrade -y && apt -y dist-upgrade && apt -y autoremove
}

upd_get_cpus() {
    yq .cpus /var/qyc/cnf.yaml
}

upd_get_ram_mb() {
    yq .ram_in_mb /var/qyc/cnf.yaml
}

#upd_firewall() {
#sec_install=$(yq .sec_install /var/qyc/cnf.yaml)
#if [[ "$sec_install" == "yes" ]]; then
# shellcheck disable=SC1091
#source /var/qyc/qycli/sec_firewall
#fi
#}

upd_nginx_conf_renew_cf_ips() {
    if [[ -f /etc/qyc/nginx/conf.d/cloudflare.conf ]]; then
        rm /etc/qyc/nginx/conf.d/cloudflare.conf
    fi
    # shellcheck disable=SC2013
    for cfip in $(
        cat /var/qyc/cache/cloudflare_ipv6_ips
        echo ""
        cat /var/qyc/cache/cloudflare_ipv4_ips
    ); do
        echo "set_real_ip_from $cfip;" | tee -a /etc/qyc/nginx/conf.d/cloudflare.conf >/dev/null
    done
    echo 'real_ip_header CF-Connecting-IP;' | tee -a /etc/qyc/nginx/conf.d/cloudflare.conf >/dev/null
    echo 'real_ip_recursive on;' | tee -a /etc/qyc/nginx/conf.d/cloudflare.conf >/dev/null

    systemctl reload nginx
}

upd_nginx_conf() {
    cp -rf /var/qyc/qycli/cnf/nginx/* /etc/qyc/nginx/
    [[ -f /lib/systemd/system/nginx.service ]] && cp /var/qyc/qycli/cnf/nginx/nginx.service /lib/systemd/system/nginx.service && systemctl daemon-reload

    worker_processes=$(upd_get_cpus)                # 1 worker per CPU
    worker_connections=$(($(upd_get_cpus) * 10000)) # 10000 per CPU
    sed -i "s+.*worker_processes.*+worker_processes ${worker_processes};+" /etc/qyc/nginx/nginx.conf
    sed -i "s+.*worker_connections.*+    worker_connections ${worker_connections};+" /etc/qyc/nginx/nginx.conf

    systemctl reload nginx
}

upd_nginx() {
    nginx_release_tag=$(curl -sI https://github.com/HOSTYON/qycli-nginx/releases/latest | tac | tac | grep "location:" | sed -z "s+.*/++" | tr -d '\r')
    nginx_source=$(eval echo "$(yq .nginx_source /var/qyc/cnf.yaml)")

    if [[ ! -f /var/qyc/cache/nginx_release_tag_old || $nginx_release_tag != $(cat /var/qyc/cache/nginx_release_tag_old) ]]; then
        echo "$nginx_release_tag" >/var/qyc/cache/nginx_release_tag_old

        cp /var/qyc/qycli/cnf/nginx/nginx.service /lib/systemd/system/nginx.service
        systemctl daemon-reload

        eval "wget" -O- "$nginx_source" |
            tar xJ --strip-components=4 -C /var/qyc/bin/

        cp -r /var/qyc/bin/nginx/etc/* /etc/qyc/nginx

        systemctl restart nginx
        systemctl reenable nginx
    fi
}

upd_mariadb_conf_ram_based() {
    local innodb_buffer_pool_size=$(($(upd_get_ram_mb) * 20 / 100)) # 20% of all memory in MB
    local innodb_log_file_size=$(($(upd_get_ram_mb) * 10 / 100))    # 10% of all memory in MB
    local tmp_table_size=$(($(upd_get_ram_mb) * 64 / 1000))         # Per GB RAM 64MB
    sed -e "s/.*innodb_buffer_pool_size.*/innodb_buffer_pool_size = ${innodb_buffer_pool_size}M/" \
        -e "s/.*innodb_log_file_size.*/innodb_log_file_size = ${innodb_log_file_size}M/" \
        -e "s/.*tmp_table_size.*/tmp_table_size = ${tmp_table_size}M/" \
        -e "s/.*max_heap_table_size.*/max_heap_table_size = ${tmp_table_size}M/" -i /etc/mysql/mariadb.conf.d/99-qyc.cnf

}

upd_mariadb_conf_cpu_based() {
    local max_connections=$(($(upd_get_cpus) * 512)) # 512 times CPU cores
    local query_cache_size=$(($(upd_get_cpus) * 64)) # 64 times CPU cores
    sed -e "s/.*max_connections.*/max_connections = ${max_connections}/" \
        -e "s/.*query_cache_size.*/query_cache_size = ${query_cache_size}M/" -i /etc/mysql/mariadb.conf.d/99-qyc.cnf
}

upd_mariadb_conf() {
    cp /var/qyc/qycli/cnf/mysql/mariadb.conf.d/99-qyc.cnf /etc/mysql/mariadb.conf.d/99-qyc.cnf
    upd_mariadb_conf_ram_based
    upd_mariadb_conf_cpu_based
    systemctl restart mariadb
}

upd_php_service_file() {
    cp /var/qyc/qycli/cnf/php/php-fpm.service /lib/systemd/system/php-fpm.service
    sed "s/PHPVER/$php_version_short/" -i /lib/systemd/system/php-fpm.service
    systemctl daemon-reload
}

upd_php_conf() {
    [[ ! -d /etc/qyc/php/fpm ]] && mkdir -p /etc/qyc/php/fpm
    cp -rf /var/qyc/qycli/cnf/php/* /etc/qyc/php/
    chown -R qycli:qycli /etc/qyc/php

    local opmem=$(($(upd_get_ram_mb) * 10 / 100)) # 10% of all memory in MB
    cp /var/qyc/qycli/cnf/php/fpm/php.ini /etc/qyc/php/fpm/php.ini
    sed -e "s/.*opcache.memory_consumption.*/opcache.memory_consumption = ${opmem}M/" \
        -e "s/.*opcache.jit_buffer_size.*/opcache.jit_buffer_size = ${opmem}M/" -i /etc/qyc/php/fpm/php.ini

    local maxchil=$(($(upd_get_ram_mb) * 60 / 160 / 100)) # pm.max_children = 60% Total Memory / 160MB
    cp /var/qyc/qycli/cnf/php/fpm/pool.d/qycli.conf /etc/qyc/php/fpm/pool.d/qycli.conf
    sed -e "s/.*pm.max_children.*/pm.max_children = ${maxchil}/" -i /etc/qyc/php/fpm/pool.d/qycli.conf

    php_version=$(yq .php_version /var/qyc/cnf.yaml) # Reading the qycli.cnf file
    php_version_short=$(echo "$php_version" | tr -d ".")

    [[ -f /lib/systemd/system/php-fpm.service ]] && upd_php_service_file

    [[ ! -d /run/qycli ]] && mkdir /run/qycli

    systemctl restart php-fpm
}

upd_php() {
    php_version=$(yq .php_version /var/qyc/cnf.yaml) # Reading the qycli.cnf file
    php_version_short=$(echo "$php_version" | tr -d ".")
    php_release_tag=$(curl -si https://github.com/HOSTYON/qycli-php"$php_version_short"/releases/latest | tac | tac | grep "location:" | sed -z "s+.*/++" | tr -d '\r')
    php_source=$(eval echo "$(yq .php_source /var/qyc/cnf.yaml)")

    if [[ ! -f /var/qyc/cache/php_release_tag_old || $php_release_tag != $(cat /var/qyc/cache/php_release_tag_old) ]]; then
        echo "$php_release_tag" >/var/qyc/cache/php_release_tag_old

        eval "wget" -O- "$php_source" |
            tar xJ --strip-components=4 -C /var/qyc/bin/

        for bin in /var/qyc/bin/php"$php_version_short"/bin/*; do
            [[ -f /usr/bin/"$(basename "$bin")" ]] && rm /usr/bin/"$(basename "$bin")"
            ln -s "$bin" /usr/bin/"$(basename "$bin")"
        done

        ln -s /etc/qyc/php/fpm/php.ini /var/qyc/bin/php"$php_version_short"/lib/php.ini

        upd_php_service_file

        systemctl restart php-fpm
        systemctl reenable php-fpm
    fi
}

upd_redis_conf() {
    cp /var/qyc/qycli/cnf/redis/redis.conf /etc/redis/redis.conf
    local redismem=$(($(upd_get_ram_mb) * 20 / 100)) # 20% of all memory in MB
    sed -i "s+maxmemory[[:space:]].*+maxmemory ${redismem}mb+g" /etc/redis/redis.conf
    systemctl restart redis-server
}

upd_redis_service() {
    if ! cmp -s /var/qyc/qycli/cnf/redis/redis-server.service /lib/systemd/system/redis-server.service; then
        cp /var/qyc/qycli/cnf/redis/redis-server.service /lib/systemd/system/redis-server.service
        systemctl daemon-reload
        systemctl enable redis-server
        systemctl restart redis-server
    fi
}

upd_pma_conf() {
    cp /var/qyc/qycli/cnf/redis/redis-server.service /lib/systemd/system/redis-server.service
    cp /var/www/pma/config.sample.inc.php /var/www/pma/config.inc.php
}

upd_system_resources_qycli_cnf() {
    cpus=$(grep -c processor /proc/cpuinfo)
    ram_in_mb=$(($(grep MemTotal /proc/meminfo | tr -d 'MemTotal: kB') / 1000))

    if ! grep -q "cpus" /var/qyc/cnf.yaml; then
        echo "cpus: $cpus" >>/var/qyc/cnf.yaml
    fi
    if [[ $cpus != $(yq .cpus /var/qyc/cnf.yaml) ]]; then
        sed -i "s+.*cpus.*+cpus: $cpus+" /var/qyc/cnf.yaml
    fi

    if ! grep -q "ram_in_mb" /var/qyc/cnf.yaml; then
        echo "ram_in_mb: $ram_in_mb" >>/var/qyc/cnf.yaml
    fi
    if [[ $ram_in_mb != $(yq .ram_in_mb /var/qyc/cnf.yaml) ]]; then
        sed -i "s+.*ram_in_mb.*+ram_in_mb: $ram_in_mb+" /var/qyc/cnf.yaml
    fi
}

upd_get_new_cf_ips() {
    curl -s https://www.cloudflare.com/ips-v4 -o /var/qyc/cache/cloudflare_ipv4_ips_new
    curl -s https://www.cloudflare.com/ips-v6 -o /var/qyc/cache/cloudflare_ipv6_ips_new
    if ! cmp -s /var/qyc/cache/cloudflare_ipv4_ips_new /var/qyc/cache/cloudflare_ipv4_ips || ! cmp -s /var/qyc/cache/cloudflare_ipv6_ips_new /var/qyc/cache/cloudflare_ipv6_ips; then
        cp /var/qyc/cache/cloudflare_ipv4_ips_new /var/qyc/cache/cloudflare_ipv4_ips
        cp /var/qyc/cache/cloudflare_ipv6_ips_new /var/qyc/cache/cloudflare_ipv6_ips
        #upd_firewall
        upd_nginx_conf_renew_cf_ips
    fi
}

upd_get_cf_token_accounts_and_zones() {
    cf_token=$(yq .cloudflare_token /var/qyc/cnf.yaml)
    hostname=$(cat /etc/hostname)
    get_public_ips
    if [[ $ipv6 != "" ]]; then
        pub_ip="$ipv6"
    elif [[ $ipv4 != "" ]]; then
        pub_ip="$ipv4"
    fi

    # Create Accounts Zones and DNS Token
    curl -X POST "https://api.cloudflare.com/client/v4/user/tokens" \
        -H "Authorization: Bearer $cf_token" \
        -H "Content-Type: application/json" \
        --data '{"name":"qycli - Read Account Settings and Zones - '"$hostname"' - '"$pub_ip"'","policies":[{"effect":"allow","resources":{"com.cloudflare.api.account.*":"*"},"permission_groups":[{"id":"c1fde68c7bcc44588cbb6ddbc16d6480","name":"Account Settings Read"}]},{"effect":"allow","resources":{"com.cloudflare.api.account.zone.*":"*"},"permission_groups":[{"id":"c8fed203ed3043cba015a93ad1616f1f","name":"Zone Read"}]}]}' >/var/qyc/cloudflare/cf_token_accounts_zones.json
}

upd_get_cf_accounts_and_zones() {
    cf_token_accounts_zones=$(yq .result.value </var/qyc/cloudflare/cf_token_accounts_zones.json)

    # Get all accounts
    curl -s -X GET "https://api.cloudflare.com/client/v4/accounts?page=1&per_page=1000" \
        -H "Authorization: Bearer $cf_token_accounts_zones" \
        -H "Content-Type: application/json" >/var/qyc/cloudflare/cfaccounts.json

    # Get all zones of all accounts
    [[ -f /var/qyc/cloudflare/cfzones.json ]] && rm /var/qyc/cloudflare/cfzones.json
    touch /var/qyc/cloudflare/cfzones.json
    for id in $(yq '.result[].id' </var/qyc/cloudflare/cfaccounts.json); do
        curl -X GET "https://api.cloudflare.com/client/v4/zones?status=active&account.id=$id&page=1&per_page=500" \
            -H "Authorization: Bearer $cf_token_accounts_zones" \
            -H "Content-Type: application/json" | yq ea -i /var/qyc/cloudflare/cfzones.json -
    done
}

upd_dns_entry() {
    cf_token_dns=$(yq .cloudflare_token /var/qyc/cnf.yaml)
    # Check if dns file exists
    # shellcheck disable=SC2154
    if [[ -f ${domain}_cf_dns.json ]]; then
        dns_update_id=$(yq .result.id "$domain"_cf_dns.json)
        curl -X PUT "https://api.cloudflare.com/client/v4/zones/$root_domain_zone_id/dns_records/$dns_update_id" \
            -H "Authorization: Bearer $cf_token_dns" \
            -H "Content-Type: application/json" \
            --data '{"type":"'"$dns_type"'","name":"'"$domain"'","content":"'"$dns_value"'","ttl":1,"proxied":true}' >"$domain"_cf_dns.json
    fi
}

upd_composer() {
    EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

    if [[ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]]; then
        echo >&2 'ERROR: Invalid installer checksum'
        rm composer-setup.php
        exit 1
    fi

    php composer-setup.php --quiet --filename=composer --install-dir=/var/qyc/bin/
    RESULT=$?
    rm composer-setup.php
    echo $RESULT

    tee /usr/local/bin/composer >/dev/null <<'EOF'
runuser -u qycli -- /var/qyc/bin/composer $@
EOF
    chmod +x /usr/local/bin/composer
}

upd_phpmyadmin() {
    composer -d/var/www/pma --with-all-dependencies update
}

upd_tinyfilemanager() {
    git -C /var/www/tfm reset --hard HEAD
    git -C /var/www/tfm pull

    sed 's+//editor.setTheme(.*+editor.setTheme("ace/theme/monokai");+' -i /var/www/tfm/tinyfilemanager.php
    sed '/editor.setTheme("ace\/theme\/monokai");/a editor.setOptions({fontSize: "14px"});' -i /var/www/tfm/tinyfilemanager.php
    sed 's+,"theme":"light"+,"theme":"dark"+' -i /var/www/tfm/tinyfilemanager.php
    sed "s+.fm-login-page .brand{ width:121px;overflow:hidden;margin:0 auto;position:relative;z-index:1}+.fm-login-page .brand{ width:85%;overflow:hidden;margin:15px auto;position:relative;z-index:1}+" -i /var/www/tfm/tinyfilemanager.php
    sed "/.theme-dark svg g, .theme-dark svg path {fill: #ffffff; }/d" -i /var/www/tfm/tinyfilemanager.php
    sed -E '/<svg/,/\/svg>/d' -i /var/www/tfm/tinyfilemanager.php
    sed -E '/<div class="brand">/a <svg xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" clip-rule="evenodd" viewBox="0 0 300 95"><path fill="#c2e1eb" fill-rule="nonzero" d="M26.6 89.4c-1 0-1.7-.2-2.1-.7-.4-.4-.7-1.2-.7-2.3 0-1 .3-1.8.7-2.3.4-.4 1.1-.6 2-.6h7.6V66.3a17 17 0 0 1-13.8 7.2 17.6 17.6 0 0 1-16.4-9.9 25 25 0 0 1-2.4-11.2c0-4.3.8-8 2.4-11.2a17.6 17.6 0 0 1 16.4-9.9 17.9 17.9 0 0 1 14.2 7.4v-3.4c0-1.1.2-1.9.6-2.3.5-.5 1.2-.7 2.1-.7h32.5c1 0 1.7.2 2.1.7.4.4.6 1.2.6 2.3 0 1-.2 1.8-.6 2.2-.4.5-1.1.7-2.1.7h-5.6l12.3 24.5 11.7-24.5h-3.9c-1 0-1.7-.2-2-.7-.5-.4-.7-1.2-.7-2.2 0-1.1.2-1.9.6-2.3.4-.5 1.1-.7 2.1-.7H98c1 0 1.7.2 2.1.7.4.4.6 1.2.6 2.3 0 1-.2 1.8-.6 2.2-.4.5-1.1.7-2.1.7h-2.7L77.4 74.7a44.2 44.2 0 0 1-5.5 8.8 16.2 16.2 0 0 1-6.1 4.6c-2.3 1-5 1.2-8.2 1.3h-31zM57 38.2H40.6v45.3h16.1c2.8-.2 5-.4 6.7-1.2a14 14 0 0 0 4.5-4.3 59 59 0 0 0 5-8.5L57 38.2Zm-36.3-.4c-2.6 0-4.8.6-6.6 1.8-1.9 1.3-3.3 3-4.3 5.2s-1.4 4.7-1.4 7.6c0 2.9.4 5.4 1.4 7.6 1 2.2 2.4 4 4.3 5.2 1.8 1.2 4 1.8 6.6 1.8 2.6 0 4.9-.6 7-1.7 2-1.2 3.5-2.9 4.7-5 1.1-2.3 1.7-4.9 1.7-7.9s-.6-5.6-1.7-7.8a12.1 12.1 0 0 0-4.8-5c-2-1.2-4.3-1.8-6.9-1.8ZM141 31.3a4 4 0 0 1 2.5.7c.5.4.7 1.1.7 2.2v12.6c0 1-.2 1.7-.7 2.2-.5.4-1.3.6-2.5.6s-2-.2-2.6-.6c-.4-.5-.7-1.2-.7-2.2 0-1.7-.4-3.3-1.4-4.7a8.9 8.9 0 0 0-4-3.2c-2-.7-4.2-1.1-6.8-1.1a15 15 0 0 0-7.5 1.8 14 14 0 0 0-5.1 5.3 15 15 0 0 0-1.9 7.5c0 2.8.6 5.3 1.8 7.5 1.1 2.3 2.8 4 5 5.2 2.1 1.3 4.5 1.9 7.3 1.9a23.7 23.7 0 0 0 14.6-4.8c.6-.5 1.2-.7 1.7-.7.9 0 1.7.6 2.4 1.7.4.8.6 1.5.6 2.2a3 3 0 0 1-1.3 2.5 32.5 32.5 0 0 1-18 5.6c-4.1 0-7.8-1-11-2.8a19.9 19.9 0 0 1-10-18.3c0-4 1-7.6 2.7-10.8 1.8-3.1 4.2-5.7 7.4-7.5a21 21 0 0 1 18-1.3c2.1 1 4 2.3 5.5 4v-2.6c0-1 .3-1.8.7-2.2.6-.4 1.4-.7 2.6-.7zm25.3-16a3 3 0 0 1 1.8.5c.4.4.5.8.5 1.6v1l-.6 43.5c0 1.9.5 3.1 1.5 4 1 .8 2.4 1.2 4.4 1.2a18 18 0 0 0 5-.8 22.7 22.7 0 0 0 5-2.5c.5-.3 1-.4 1.3-.4.6 0 1 .2 1.4.5.4.4.7 1 1 1.6.2.6.3 1.1.3 1.7 0 1-.5 1.8-1.6 2.4a26 26 0 0 1-13.1 3.9 12 12 0 0 1-8.6-3c-2.1-1.8-3-4.5-3-8V21.4h-12c-.8 0-1.4-.2-1.7-.5-.5-.3-.6-.8-.6-1.5v-1c.3-1 .7-1.9 1.1-2.3a4 4 0 0 1 2.3-.7h15.6z"/><path fill="#c2e1eb" d="M200 13.2c1.5 0 2.6.2 3.2.7.6.3.8 1 .8 2.1v5.7c0 1-.2 1.8-.8 2.2-.6.4-1.7.6-3.3.6-1.6 0-2.6-.2-3.3-.6-.5-.4-.8-1.2-.8-2.2V16c0-1 .3-1.8.8-2.1.7-.5 1.7-.7 3.3-.7zm2.3 19.1c.8 0 1.3.1 1.7.5.4.2.6.7.6 1.4v1L204 62c0 1.8.4 3.1 1.3 4 1 .8 2.4 1.2 4.5 1.2a17.4 17.4 0 0 0 10.1-3.3 2.1 2.1 0 0 1 2.6.2 5 5 0 0 1 1.4 3.2c0 1-.6 1.8-1.7 2.4a25.4 25.4 0 0 1-13 3.9 12 12 0 0 1-8.7-3c-2-1.8-3-4.5-3-8l-.1-24.3h-11c-.8 0-1.4 0-1.7-.4-.4-.3-.6-.8-.6-1.6l.1-1c.2-1 .6-1.8 1-2.3.5-.4 1.3-.6 2.3-.6h14.8z"/><path fill="#c2e1eb" fill-opacity=".2" d="M57 38.2H40.6v45.3h16.1c2.8-.2 5-.4 6.7-1.2a14 14 0 0 0 4.5-4.3 59 59 0 0 0 5-8.5z"/><path fill="#c2e1eb" fill-opacity=".6" d="M265.4.5h-34.2v94.1h33.6a38 38 0 0 0 13.8-2.4c3.4-1.6 6.5-4.9 9.4-8.8 2.9-4 6.4-9.5 10.6-18z"><animate attributeName="opacity" attributeType="XML" begin="0" dur="1.6s" repeatCount="indefinite" values="0;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;0;0;0;0;0;0;0;0;0;"/></path></svg>' -i /var/www/tfm/tinyfilemanager.php # Insert new branding

    systemctl restart php-fpm
}

upd_yq() {
    # Install/update yq
    cpuarch=amd64
    yq_new_release_tag="$(curl -si https://github.com/mikefarah/yq/releases/latest | tac | tac | grep "location:" | sed -z "s+.*/++" | tr -d '\r')"
    yq_new_source=https://github.com/mikefarah/yq/releases/download/"$yq_new_release_tag"/yq_linux_"$cpuarch".tar.gz

    if [[ ! -f /var/qyc/cache/yq_old_source || $yq_new_source != $(cat /var/qyc/cache/yq_old_source) || ! -f /usr/bin/yq ]]; then
        wget -qO - "$yq_new_source" |
            tar xz && mv yq_linux_"$cpuarch" /usr/bin/yq
        sh install-man-page.sh
        rm install-man-page.sh && rm yq.1
        echo "$yq_new_source" >/var/qyc/cache/yq_old_source
    fi
}

upd_psl() {
    curl -s https://publicsuffix.org/list/public_suffix_list.dat | grep -vE "^//" | sed "s+\*\.++" | tr -s '\n' >/var/qyc/cache/psl
}

upd_fn() {
    upd_qycli
    upd_apt
    upd_system_resources_qycli_cnf
    upd_get_new_cf_ips
    upd_mariadb_conf
    upd_nginx
    upd_nginx_conf
    upd_php
    upd_php_conf
    upd_redis_conf
    upd_redis_service
    upd_composer
    upd_phpmyadmin
    upd_tinyfilemanager
    upd_yq
    upd_psl
}
