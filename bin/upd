#!/bin/bash

# qycli update functions
upd_apt() {
    apt update && apt upgrade -y && apt -y dist-upgrade && apt -y autoremove
}

upd_qycli() {
    git -C /opt/qycli pull https://github.com/HOSTYON/qycli
    cp /opt/qycli/bin/qyc /usr/bin/qyc
    chmod 755 /usr/bin/qyc
    chmod 755 /opt/qycli/kernel
    chmod 755 /opt/qycli/sec
}

upd_firewall() {
    sec_install=$(grep "sec_install" /var/opt/qycli/cnf | sed s+sec_install=++)
    if [[ "$sec_install" == "yes" ]]; then
        ssh_port=$(grep -w "Port" -i /etc/ssh/sshd_config | sed s+'.*Port '++)

        ufw --force disable
        ufw --force reset

        ufw default allow outgoing
        ufw default deny incoming

        ufw allow $ssh_port/tcp

        #for cfip in `cat /var/opt/qycli/cloudflare_ipv4_ips`; do ufw allow proto tcp from $cfip to any port 443 comment 'Cloudflare IP'; done
        for cfip in `cat /var/opt/qycli/cloudflare_ipv6_ips`; do ufw allow proto tcp from $cfip to any port 443 comment 'Cloudflare IP'; done

        echo "y" | ufw enable
    fi
}

upd_nginx_overwrite_from_snap() {
    cp /snap/qycli-nginx/current/etc/nginx/ /etc/nginx/
    cp /snap/qycli-nginx/current/usr/lib/nginx/modules/ /usr/lib/nginx/modules/
}

upd_nginx_conf_renew_cf_ips() {
    if [[ -f /etc/nginx/conf.d/cloudflare.conf ]]; then 
        rm /etc/nginx/conf.d/cloudflare.conf; 
    fi
    for cfip in `cat /var/opt/qycli/cloudflare_ipv6_ips`; do
        echo "set_real_ip_from $cfip;" | tee -a /etc/nginx/conf.d/cloudflare.conf >/dev/null
    done
    echo 'real_ip_header CF-Connecting-IP;' | tee -a /etc/nginx/conf.d/cloudflare.conf >/dev/null
    echo 'real_ip_recursive on;' | tee -a /etc/nginx/conf.d/cloudflare.conf >/dev/null
    nginx -s reload
}

upd_nginx_conf() {
    cp -rf /opt/qycli/cnf/nginx/ /etc/nginx/

    local workerprocs=$(grep processor /proc/cpuinfo | wc -l) # 1 worker per CPU
    local workerconn=$((($(grep processor /proc/cpuinfo | wc -l)*10240)))
    sed -i "s+workerprocs+${workerprocs}+g" /etc/nginx/nginx.conf
    sed -i "s+workerconn+${workerconn}+g" /etc/nginx/nginx.conf

    if [[ ! -f /etc/ssl/dhparam.pem ]]; then
		openssl dhparam -out /etc/ssl/dhparam.pem 2048
		chmod 600 /etc/ssl/dhparam.pem
	fi
    
    upd_nginx_conf_renew_cf_ips
}

upd_check_for_new_cf_ips() {
    curl -s https://www.cloudflare.com/ips-v4 -o /var/opt/qycli/cloudflare_ipv4_ips_new
    curl -s https://www.cloudflare.com/ips-v6 -o /var/opt/qycli/cloudflare_ipv6_ips_new
    if ! cmp -s /var/opt/qycli/cloudflare_ipv4_ips_new /var/opt/qycli/cloudflare_ipv4_ips || ! cmp -s /var/opt/qycli/cloudflare_ipv6_ips_new /var/opt/qycli/cloudflare_ipv6_ips; then
        cp /var/opt/qycli/cloudflare_ipv4_ips_new /var/opt/qycli/cloudflare_ipv4_ips
        cp /var/opt/qycli/cloudflare_ipv6_ips_new /var/opt/qycli/cloudflare_ipv6_ips
        upd_firewall
        upd_nginx_conf_renew_cf_ips
    fi
}

upd_mariadb_conf() {
    local innodbbps=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/100000)*80)) # 80% of all memory in MB
    local innodblfs=$(((${innodbbps}/100*25)))
    local dbmaxconn=$((($(grep processor /proc/cpuinfo | wc -l)*512))) # 512 times CPU cores
    local tmpsizes=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/1000000)*64)) # Per GB RAM 64MB
    local querycachesize=$((($(grep processor /proc/cpuinfo | wc -l)*64))) # 64 times CPU cores
    cp /opt/qycli/cnf/mysql/mariadb.conf.d/99-qyc.cnf /etc/mysql/mariadb.conf.d/99-qyc.cnf
    sed -e "s/\${innodbbps}/${innodbbps}/" -e "s/\${innodblfs}/${innodblfs}/" -e "s/\${dbmaxconn}/${dbmaxconn}/" /etc/mysql/mariadb.conf.d/99-qyc.cnf
    sed -e "s/\${tmpsizes}/${tmpsizes}/" -e "s/\${querycachesize}/${querycachesize}/" /etc/mysql/mariadb.conf.d/99-qyc.cnf
}

upd_php_conf() {
    mkdir -p /etc/php/fpm/pool.d

    local opmem=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/100000)*15)) # 15% of all memory in MB
    cp /opt/qycli/cnf/php/fpm/php.ini /etc/php/fpm/php.ini
    sed -e "s/\${opmem}/${opmem}/" /etc/php/fpm/php.ini

    local maxchil=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/100000)*70/80)) # pm.max_children = 70% Total Memory / 80MB
    cp /opt/qycli/cnf/php/fpm/pool.d/qycli.conf /etc/php/fpm/pool.d/qycli.conf
    sed -e "s/\${maxchil}/${maxchil}/" /etc/php/fpm/pool.d/qycli.conf
}

upd_redis_conf() {
    local redismem=$((($(grep MemTotal /proc/meminfo | cut -f 2 -d ':' | tr -d ' ' | cut -f 1 -d 'k')/100000)*20)) # 20% of all memory in MB
    sed -i "s+*maxmemory*+maxmemory ${redismem}mb+g" /etc/redis/redis.conf
}

